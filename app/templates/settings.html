{% extends "layout.html" %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1>Settings</h1>
        <p>Manage your account preferences</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="settings-card">

        <form action="{{ url_for('web.settings') }}" method="POST" enctype="multipart/form-data" class="settings-form"
            id="profileForm">
            <input type="hidden" name="action" value="update_profile">
            <input type="hidden" name="delete_avatar" id="delete_avatar_input" value="0">

            <input type="file" name="avatar" id="avatar_upload_real" accept="image/*" onchange="handleFileSelect(this)"
                style="display: none;">

            <div class="profile-section">
                <div class="avatar-wrapper">

                    <div class="large-avatar-placeholder {{ 'd-none' if user.avatar else '' }}" id="avatarPlaceholder">
                        {{ user.username[0].upper() }}
                    </div>

                    <img src="{{ url_for('stream.stream_file', filename=user.avatar) if user.avatar else '' }}"
                        class="large-avatar-img {{ '' if user.avatar else 'd-none' }}" id="avatarPreview"
                        onerror="this.classList.add('d-none'); document.getElementById('avatarPlaceholder').classList.remove('d-none');">

                    <button type="button" class="avatar-trigger-btn" onclick="openModal()">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>

                <div class="profile-info">
                    <h2>{{ user.username }}</h2>
                    <p>{{ user.email }}</p>
                </div>
            </div>

            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" value="{{ user.username }}" required class="form-input">
                <p class="form-hint">Must be unique.</p>
            </div>

            <div class="form-group">
                <label>Email Address</label>
                <input type="email" value="{{ user.email }}" readonly class="form-input readonly"
                    style="cursor: not-allowed; opacity: 0.7;">
            </div>

            <button type="submit" class="btn-primary">Save Profile Changes</button>
        </form>

        <hr class="divider">

        <h3 style="color:white; margin-bottom: 1rem;">Change Password</h3>
        <form action="{{ url_for('web.settings') }}" method="POST" class="settings-form">
            <input type="hidden" name="action" value="change_password">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" name="current_password" required class="form-input">
            </div>
            <div class="d-flex" style="gap: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1;">
                    <label>New Password</label>
                    <input type="password" name="new_password" required class="form-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Confirm New Password</label>
                    <input type="password" name="confirm_password" required class="form-input">
                </div>
            </div>
            <button type="submit" class="btn-secondary">Update Password</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="avatarModal" onclick="closeModalOnClickOutside(event)">
    <div class="modal-box">
        <div class="modal-header">Change Profile Photo</div>
        <div class="modal-options">
            <button class="modal-btn upload" onclick="triggerFileInput()">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload New Photo
            </button>

            {% if user.avatar %}
            <button class="modal-btn remove" onclick="confirmRemove()">
                <i class="fa-solid fa-trash"></i> Remove Current Photo
            </button>
            {% else %}
            <button class="modal-btn remove disabled" disabled>
                <i class="fa-solid fa-trash"></i> Remove Current Photo
            </button>
            {% endif %}

            <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('avatarModal');
    const fileInput = document.getElementById('avatar_upload_real');
    const form = document.getElementById('profileForm');
    const deleteInput = document.getElementById('delete_avatar_input');

    // --- MODAL FUNCTIONS ---
    function openModal() { modal.classList.add('active'); }
    function closeModal() { modal.classList.remove('active'); }
    function closeModalOnClickOutside(event) { if (event.target === modal) closeModal(); }

    function triggerFileInput() {
        closeModal();
        fileInput.click();
    }

    // --- INSTANT PREVIEW LOGIC ---
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                // 1. Hide Placeholder using Class
                const placeholder = document.getElementById('avatarPlaceholder');
                if (placeholder) placeholder.classList.add('d-none');

                // 2. Show Image using Class & Update Source
                const img = document.getElementById('avatarPreview');
                img.src = e.target.result;
                img.classList.remove('d-none');
            }

            reader.readAsDataURL(file);

            // Reset delete flag (user changed mind and is uploading instead)
            if (deleteInput) deleteInput.value = '0';

            // Visual Cue
            const saveBtn = form.querySelector('.btn-primary');
            saveBtn.innerText = "Save New Picture";
            saveBtn.style.background = '#10b981';
        }
    }

    function confirmRemove() {
        if (confirm("Remove profile picture?")) {
            closeModal();
            deleteInput.value = '1';
            fileInput.value = ''; // clear any selected file
            form.submit();
        }
    }
</script>
{% endblock %}